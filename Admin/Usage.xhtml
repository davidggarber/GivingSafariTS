<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8" />
    <script> var exports = {}; </script>
    <script src="../js/kit25.js" />
    <script src="sync.js" />
    <link href="sync.css" rel="Stylesheet" type="text/css"></link>
    <script>
      //<![CDATA[
      const boiler = {
        safari: 'Admin',
        orientation: 'landscape',
        title: 'Usage Statistics',
        postSetup: doRefresh,
        reactiveBuilder: 'pageBody',
        lookup: {},
      };

      var eventName = identifyEvent();
      var firstLoad = true;

      function doRefresh() {
        var data = {
          eventName: eventName,
          data: 'counts'
        }
        queryServer('UsageSummary', data, refreshWithResponse)
      }

      function refreshWithResponse(response) {
        var list = JSON.parse(response);

        console.log(list.length);
        
        var tbody = document.getElementById('puzzles-tbody');
        
        // See what rows we already have
        var existing = rowIdSet(tbody, true);

        for (var row of list) {
          var name = row["PuzzleName"];
          var id = "puzzle-" + name;
          if (name == "") {
            id = 'combined-tfoot';
          }
          var tr = document.getElementById(id);
          if (tr) {
            // Already exists, but update the scores
            var td = tr.getElementsByClassName('o-count')[0];
            toggleClass(tr, 'new', td.innerText != row["Opened"]);
            td.innerText = row["Opened"];

            td = tr.getElementsByClassName('e-count')[0];
            toggleClass(tr, 'new', td.innerText != row["Edited"]);
            td.innerText = row["Edited"];

            td = tr.getElementsByClassName('a-count')[0];
            toggleClass(tr, 'new', td.innerText != row["Attempted"]);
            td.innerText = row["Attempted"];

            td = tr.getElementsByClassName('s-count')[0];
            toggleClass(tr, 'new', td.innerText != row["Solved"]);
            td.innerText = row["Solved"];

            td = tr.getElementsByClassName('u-count')[0];
            toggleClass(tr, 'new', td.innerText != row["Unique"]);
            td.innerText = row["Unique"];

            existing[id] = null;
          }
          else {
            var data = {
              PuzzleName: name,
              Opened: row["Opened"],
              Edited: row["Edited"],
              Attempted: row["Attempted"],
              Solved: row["Solved"],
              Unique: row["Unique"],
            }
            var tr = appendFromTemplate(tbody, 'puzzleRow', data);
            toggleClass(tr, 'new', !firstLoad);
          }
        }

        // If any pre-existing rows have gone missing, tag them
        var missing = Object.entries(existing).filter(pair => pair[1]).map(pair => pair[0]);
        markAsMissing(missing);

        firstLoad = false;
      }

      // ]]>
    </script>
    <style>
      #page {
        height:12in;
      }
      .zName {
        min-width: 2in;
      }
      tr:hover .puzzle-name {
        font-weight: bold;
      }
    </style>
  </head>
  <body id="ListPuzzles">
    <!--
        A list of all known puzzles, with links to additional information.
      -->
    <div id="pageBody">
      <button onclick="doRefresh()">Refresh Puzzle List</button>
      <table style="width:100%">
        <thead>
          <tr>
            <th colspan="3"><h1>Puzzles</h1></th>
          </tr>
          <tr class="sortable">
            <use template="sortableTH" text="Name" cls="zName" />
            <use template="sortableTH" text="Opened" cls="sort-numeric" />
            <use template="sortableTH" text="Edited" cls="sort-numeric" />
            <use template="sortableTH" text="Attempted" cls="sort-numeric" />
            <use template="sortableTH" text="Solved" cls="sort-numeric" />
            <use template="sortableTH" text="Unique" cls="sort-numeric" />
          </tr>
        </thead>
        <tbody id="puzzles-tbody" class="alternate">
        </tbody>
        <tfoot>
          <tr id="combined-tfoot">
            <td>(unique)</td>
            <td class="o-count"></td>
            <td class="e-count"></td>
            <td class="a-count"></td>
            <td class="s-count"></td>
            <td class="u-count"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <template id="sortableTH">
      <tth onclick="sortTable(this)" trim="all" class="{?cls}">
        {text}
        <span class="ascArrow">↓</span>
        <span class="descArrow">↑</span>
      </tth>
    </template>

    <template id="puzzleRow">
      <tr id="puzzle-{PuzzleName}">
          <td class="puzzle-name">{PuzzleName}</td>
          <td class="o-count">{Opened}</td>
          <td class="e-count">{Edited}</td>
          <td class="a-count">{Attempted}</td>
          <td class="s-count">{Solved}</td>
          <td class="u-count">{Unique}</td>
      </tr>
    </template>
  </body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8" />
    <script> var exports = {}; </script>
    <script src="../js/kit24.js" />
    <script src="sync.js" />
    <link href="sync.css" rel="Stylesheet" type="text/css"></link>
    <script>
      //<![CDATA[
      const boiler = {
        safari: 'Admin',
        orientation: 'landscape',
        title: 'List Puzzles',
        postSetup: doRefresh,
      };

      var eventName = 'GivingSafari24';  // TODO: get from URL
      var firstLoad = true;

      function doRefresh() {
        var data = {
          eventName: eventName,
        }
        queryServer('PuzzleList', data, refreshWithResponse)
      }

      function refreshWithResponse(response) {
        var list = JSON.parse(response);
        var pList = list.filter(r => r.PuzzleType == "Puzzle").map(r => r.PuzzleName);
        refreshTable("puzzle", pList);
        pList = list.filter(r => r.PuzzleType == "Meta").map(r => r.PuzzleName);
        refreshTable("meta", pList);
      }

      function refreshTable(id, list) {
        var tbody = document.getElementById(id + '-tbody');
        
        // See what rows we already have
        var existing = rowIdSet(tbody, true);

        for (var row of list) {
          var id = "puzzle-" + row;
          if (document.getElementById(id)) {
            // Already exists
            toggleClass(tr, 'missing', true);
            existing[id] = null;
          }
          else {
            var tr = createRow1(id, row, 'puzzle-name');
            toggleClass(tr, 'new', !firstLoad);
            tr.appendChild(createLinkCell('Submitted', 'Attempts.xhtml?z=' + encodeURIComponent(row)));
            tr.appendChild(createLinkCell('Team progress', 'Completion.xhtml?z=' + encodeURIComponent(row)));
            tbody.appendChild(tr);
          }
        }

        // If any pre-existing rows have gone missing, tag them
        var missing = Object.entries(existing).filter(pair => pair[1]).map(pair => pair[0]);
        markAsMissing(missing);

        firstLoad = false;
      }

      // ]]>
    </script>
    <style>
      #page {
        height:12in;
      }
    </style>
  </head>
  <body id="ListPuzzles">
    <div id="pageBody">
      <button onclick="doRefresh()">Refresh Puzzle List</button>
      <table style="width:100%;">
        <thead>
          <tr>
            <th colspan="3"><h1>Puzzles</h1></th>
          </tr>
          <tr id="header-row">
            <th style="min-width:2in;">Name</th>
            <th style="min-width:1.5in;">Attempts</th>
            <th style="min-width:1.5in;">Team progress</th>
          </tr>
        </thead>
        <tbody id="puzzle-tbody" class="alternate">
          
        </tbody>
      </table>
      <table style="width:100%;">
        <thead>
          <tr>
            <th colspan="3"><h1>Meta-Puzzles</h1></th>
          </tr>
          <tr id="header-row">
            <th style="min-width:2in;">Name</th>
            <th style="min-width:1.5in;">Attempts</th>
            <th style="min-width:1.5in;">Team progress</th>
          </tr>
        </thead>
        <tbody id="meta-tbody" class="alternate">
          
        </tbody>
      </table>

    </div>
  </body>
</html>
